# test of all stable versions
# cf https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/_data/changelogs/lts.yml
# generated by ./update_version.sh .version
name: tests jenkins versions

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      jenkins-versions:
        required: true
        description: "jenkins versions to test (default: \"last-good-version lts 2.89.4 2.107.1 2.107.2 2.107.3 2.121.1 2.121.2 2.121.3 2.138.1 2.138.2 2.138.3 2.138.4 2.150.1 2.150.2 2.150.3 2.164.1 2.164.2 2.164.3 2.176.1 2.176.2 2.176.3 2.176.4 2.190.1 2.190.2 2.190.3 2.204.1 2.204.2 2.204.3 2.204.4 2.204.5 2.204.6 2.222.1 2.222.3 2.222.4 2.235.1 2.235.2 2.235.3 2.235.4 2.235.5 2.249.1 2.249.2 2.249.3 2.263.1 2.263.2 2.263.3 2.263.4 2.277.1 2.277.2 2.277.3 2.277.4 2.289.1 2.289.2 2.289.3 2.303.1 2.303.2 2.303.3 2.319.1 2.319.2 2.319.3 2.332.1 2.332.2 2.332.3 2.332.4 2.346.1 2.346.2 2.346.3 2.361.1 2.361.2 2.361.3 2.361.4 2.375.1 2.375.2 2.375.3 2.375.4 2.387.1 2.387.2 2.387.3 2.401.1 2.401.2 2.401.3 2.414.1 2.414.2 2.414.3 2.426.1 2.426.2 2.426.3 2.440.1 2.440.2 2.440.3 2.452.1 2.452.2 2.452.3 2.452.4 2.462.1 2.462.2 2.462.3 2.479.1 2.479.2 2.479.3 2.492.1 2.492.2 2.492.3 2.504.1 2.504.2 2.504.3 2.516.1 2.516.2\")"
  schedule:
    - cron:  '0 19 * * 2'

jobs:
  gen-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix_json: ${{ steps.gen-matrix.outputs.matrix_json }}
    steps:
      - name: gen-matrix
        id: gen-matrix
        run: |
          # default ; test on a few LTS versions from https://www.jenkins.io/changelog-stable/
          default_versions="last-good-version lts 2.89.4 2.107.1 2.107.2 2.107.3 2.121.1 2.121.2 2.121.3 2.138.1 2.138.2 2.138.3 2.138.4 2.150.1 2.150.2 2.150.3 2.164.1 2.164.2 2.164.3 2.176.1 2.176.2 2.176.3 2.176.4 2.190.1 2.190.2 2.190.3 2.204.1 2.204.2 2.204.3 2.204.4 2.204.5 2.204.6 2.222.1 2.222.3 2.222.4 2.235.1 2.235.2 2.235.3 2.235.4 2.235.5 2.249.1 2.249.2 2.249.3 2.263.1 2.263.2 2.263.3 2.263.4 2.277.1 2.277.2 2.277.3 2.277.4 2.289.1 2.289.2 2.289.3 2.303.1 2.303.2 2.303.3 2.319.1 2.319.2 2.319.3 2.332.1 2.332.2 2.332.3 2.332.4 2.346.1 2.346.2 2.346.3 2.361.1 2.361.2 2.361.3 2.361.4 2.375.1 2.375.2 2.375.3 2.375.4 2.387.1 2.387.2 2.387.3 2.401.1 2.401.2 2.401.3 2.414.1 2.414.2 2.414.3 2.426.1 2.426.2 2.426.3 2.440.1 2.440.2 2.440.3 2.452.1 2.452.2 2.452.3 2.452.4 2.462.1 2.462.2 2.462.3 2.479.1 2.479.2 2.479.3 2.492.1 2.492.2 2.492.3 2.504.1 2.504.2 2.504.3 2.516.1 2.516.2"
          matrix_versions="${{ inputs.jenkins-versions }}"
          matrix_versions="${matrix_versions:-${default_versions}}"
          versions_json=$(for ver in ${matrix_versions}; do echo "{'version':'${ver}'},"; done)
          versions_json=$(echo "${versions_json%?}" | tr '\n' ' ')
          echo "matrix_json={'include':[${versions_json%?}]}" >> $GITHUB_OUTPUT

  jenkins-versions:
    needs: gen-matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON( needs.gen-matrix.outputs.matrix_json ) }}
    runs-on: ubuntu-latest
    name: test on jenkins-${{ matrix.version }}
    steps:
      - uses: actions/checkout@v5

      # test lts and lgv with their plugin list (fixed for lgv)
      - name: test jenkins-${{ matrix.version }} with default plugin list
        if: matrix.version == 'lts' || matrix.version == 'last-good-version'
        uses: ./
        with:
          version: ${{ matrix.version }}

      # tests all with no plugins
      - name: test jenkins-${{ matrix.version }} with empty plugin list
        uses: ./
        with:
          version: ${{ matrix.version }}
          plugins: test/empty-plugins.txt

      # test old versions of jenkins with fixed versions of plugins
      - name: test jenkins-${{ matrix.version }} with fixed versions of plugins
        if: matrix.version == '2.190.1'
        uses: ./
        with:
          version: ${{ matrix.version }}
          plugins: test/plugins-${{ matrix.version }}.txt
